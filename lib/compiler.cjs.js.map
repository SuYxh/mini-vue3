{"version":3,"file":"compiler.cjs.js","sources":["../src/compiler-core/src/parse.ts"],"sourcesContent":["import { NodeTypes } from \"./ast\";\n\nconst enum TagType {\n  Start,\n  End,\n}\n\nexport function baseParse(content: string) {\n  const context = createParserContext(content);\n  return createRoot(parseChildren(context, []));\n}\n\nfunction parseChildren(context, ancestors) {\n  debugger\n\n  const nodes: any = [];\n\n  while (!isEnd(context, ancestors)) {\n    let node;\n    const s = context.source;\n    if (s.startsWith(\"{{\")) {\n      node = parseInterpolation(context);\n    } else if (s[0] === \"<\") {\n      if (/[a-z]/i.test(s[1])) {\n        node = parseElement(context, ancestors);\n      }\n    }\n\n    if (!node) {\n      node = parseText(context);\n    }\n\n    nodes.push(node);\n  }\n  return nodes;\n}\n\nfunction isEnd(context, ancestors) {\n  const s = context.source;\n  if (s.startsWith(\"</\")) {\n    for (let i = ancestors.length - 1; i >= 0; i--) {\n      const tag = ancestors[i].tag;\n      if (startsWithEndTagOpen(s, tag)) {\n        return true;\n      }\n    }\n  }\n  return !s;\n}\n\nfunction parseText(context: any) {\n  let endIndex = context.source.length;\n  let endTokens = [\"<\", \"{{\"];\n\n  for (let i = 0; i < endTokens.length; i++) {\n    const index = context.source.indexOf(endTokens[i]);\n    if (index !== -1 && endIndex > index) {\n      endIndex = index;\n    }\n  }\n\n  const content = parseTextData(context, endIndex);\n\n  return {\n    type: NodeTypes.TEXT,\n    content,\n  };\n}\n\nfunction parseTextData(context: any, length) {\n  const content = context.source.slice(0, length);\n\n  advanceBy(context, length);\n  return content;\n}\n\nfunction parseElement(context: any, ancestors) {\n  const element: any = parseTag(context, TagType.Start);\n  ancestors.push(element);\n  element.children = parseChildren(context, ancestors);\n  ancestors.pop();\n  if (startsWithEndTagOpen(context.source, element.tag)) {\n    parseTag(context, TagType.End);\n  } else {\n    throw new Error(`缺少结束标签:${element.tag}`);\n  }\n\n  return element;\n}\n\nfunction startsWithEndTagOpen(source, tag) {\n  return (\n    source.startsWith(\"</\") &&\n    source.slice(2, 2 + tag.length).toLowerCase() === tag.toLowerCase()\n  );\n}\n\nfunction parseTag(context: any, type: TagType) {\n  const match: any = /^<\\/?([a-z]*)/i.exec(context.source);\n  const tag = match[1];\n  advanceBy(context, match[0].length);\n  advanceBy(context, 1);\n\n  if (type === TagType.End) return;\n\n  return {\n    type: NodeTypes.ELEMENT,\n    tag,\n  };\n}\n\nfunction parseInterpolation(context) {\n  // {{message}}\n  const openDelimiter = \"{{\";\n  const closeDelimiter = \"}}\";\n\n  const closeIndex = context.source.indexOf(\n    closeDelimiter,\n    openDelimiter.length\n  );\n\n  advanceBy(context, openDelimiter.length);\n\n  const rawContentLength = closeIndex - openDelimiter.length;\n\n  const rawContent = parseTextData(context, rawContentLength);\n\n  const content = rawContent.trim();\n\n  advanceBy(context, closeDelimiter.length);\n\n  return {\n    type: NodeTypes.INTERPOLATION,\n    content: {\n      type: NodeTypes.SIMPLE_EXPRESSION,\n      content: content,\n    },\n  };\n}\n\nfunction advanceBy(context: any, length: number) {\n  context.source = context.source.slice(length);\n}\n\nfunction createRoot(children) {\n  return {\n    children,\n  };\n}\n\nfunction createParserContext(content: string): any {\n  return {\n    source: content,\n  };\n}\n"],"names":[],"mappings":"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"}